import io.agroal.api.AgroalDataSource;
import org.hibernate.Session;
import org.hibernate.stat.Statistics;
import jakarta.inject.Inject;
import jakarta.transaction.Transactional;
import jakarta.enterprise.context.ApplicationScoped;

@ApplicationScoped
public class PedidoService {

    @Inject
    EntityManager em;

    @Inject
    AgroalDataSource dataSource; // Injeta o gerenciador de conexões

    @Transactional
    public void compararDesempenho(Long id) {
        
        // --- 1. Estado Inicial (Antes de tudo) ---
        System.out.println("--- INÍCIO: Pool de Conexões ---");
        verConexoes(); // Deve mostrar 0 ou 1 ativa (a própria transação)

        Statistics stats = em.unwrap(Session.class).getSessionFactory().getStatistics();
        stats.clear();
        
        long inicio = System.nanoTime();

        // --- CENÁRIO 1 ---
        Pedido p1 = Pedido.find("#Pedido.comItens", id).firstResult();
        
        long fimJoinFetch = System.nanoTime();
        
        System.out.println("--- APÓS JOIN FETCH ---");
        verConexoes(); // Ainda deve ser 1 conexão ativa
        
        stats.clear();
        
        // --- CENÁRIO 2 ---
        Pedido p2 = Pedido.findById(id);
        p2.itens.size(); 

        long fimBatchSize = System.nanoTime();

        System.out.println("--- APÓS BATCH SIZE ---");
        verConexoes(); // Ainda deve ser 1 conexão ativa

        // ... Impressão dos resultados de tempo ...
    }

    // Método auxiliar para não repetir código
    private void verConexoes() {
        System.out.println("Conexões ativas: " + dataSource.getMetrics().activeCount());
        System.out.println("Conexões disponíveis: " + dataSource.getMetrics().availableCount());
    }
}

# Habilita as estatísticas do Hibernate (tem leve impacto em performance, use em dev/test)
quarkus.hibernate-orm.statistics=true

# Mostra as queries SQL no console (essencial para ver quantas queries estão rodando)
quarkus.hibernate-orm.log.sql=true

# Mostra parâmetros das queries (opcional)
quarkus.hibernate-orm.log.bind-parameters=true

quarkus.datasource.metrics.enabled=true
